<script>
const startBtn = document.getElementById('start');
const stopBtn  = document.getElementById('stop');
const subj     = document.getElementById('subject') || { value: "" };
const statusEl = document.getElementById('status');
const elapsed  = document.getElementById('elapsed') || { textContent: "" };

let id=null, t0=null, timer=null;

function fmt(ms){ const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
  const pad=n=>String(n).padStart(2,'0'); return `${pad(h)}:${pad(m)}:${pad(sec)}`; }
function setRun(r){ startBtn.disabled=r; stopBtn.disabled=!r; }
async function post(path, body){
  const r = await fetch(path, { method:"POST", headers:{ "Content-Type": "application/json" }, body: JSON.stringify(body||{}) });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

startBtn.onclick = async () => {
  try {
    statusEl.textContent = "Startingâ€¦";
    const res = await post('/start', { subject: subj.value });
    id = typeof res.id === 'string' ? res.id : (res.id && (res.id.$oid || res.id.id || res.id.oid)) || '';
    if(!id){ statusEl.textContent = "Start error (no id)"; return; }
    t0 = Date.now();
    timer = setInterval(()=> elapsed.textContent = fmt(Date.now()-t0), 250);
    setRun(true);
    statusEl.textContent = "Running";
  } catch (e) {
    console.error(e); statusEl.textContent = "Start error";
  }
};

stopBtn.onclick = async () => {
  try {
    if(!id){ // fallback if id is missing
      const res = await post('/stop-latest', {});
      clearInterval(timer); setRun(false);
      statusEl.textContent = "Stopped (latest). " + (res.duration ? res.duration.toFixed(2) : ""); return;
    }
    // Try normal stop by id
    const res = await post('/stop', { id });
    clearInterval(timer); setRun(false);
    statusEl.textContent = "Stopped. " + (res.duration ? res.duration.toFixed(2) : "");
  } catch (e) {
    // Fallback to stop-latest if stop-by-id fails for any reason
    try {
      const res = await post('/stop-latest', {});
      clearInterval(timer); setRun(false);
      statusEl.textContent = "Stopped (latest). " + (res.duration ? res.duration.toFixed(2) : "");
    } catch (e2) {
      console.error(e2); statusEl.textContent = "Stop error";
    }
  }
};
</script>
